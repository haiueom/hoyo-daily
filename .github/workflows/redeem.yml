name: Auto Redeem Codes

on:
    schedule:
        - cron: '0 3 * * *'

    workflow_dispatch:
        inputs:
            auto:
                description: 'Auto Fetch Mode (-a)'
                required: true
                default: true
                type: boolean
            force:
                description: 'Force Redeem (-f)'
                required: true
                default: false
                type: boolean
            manual_args:
                description: 'Manual Codes (Opsional)'
                required: false
                type: string

jobs:
    redeem-codes:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install uv
              uses: astral-sh/setup-uv@v6
              with:
                  enable-cache: true
                  version: 'latest'

            - name: Set-up Python
              uses: actions/setup-python@v5
              with:
                  python-version-file: 'pyproject.toml'

            - name: Install dependencies
              run: uv sync --frozen

            - name: Run redeem script
              env:
                  SECRET_KEY: ${{ secrets.SECRET_KEY }}
                  COOKIE_API: ${{ secrets.COOKIE_API }}
                  DC_WH_CODE: ${{ secrets.DC_WH_CODE }}
                  # --- KONFIGURASI PENTING ---
                  # Mengambil dari Variable GitHub, jika tidak ada default ke 5 (di setting python)
                  MAX_PARALLEL: ${{ vars.MAX_PARALLEL }}
                  LOCALE: ${{ vars.LOCALE }}
                  NO_GENSHIN: ${{ vars.NO_GENSHIN }}
                  NO_STARRAIL: ${{ vars.NO_STARRAIL }}
                  NO_ZZZ: ${{ vars.NO_ZZZ }}
                  NO_HONKAI: ${{ vars.NO_HONKAI }}
                  NO_TOT: ${{ vars.NO_TOT }}
              run: |
                  ARGS=""
                  if [ "${{ github.event_name }}" == "schedule" ]; then
                    ARGS="-a"
                    echo "ðŸ“… Scheduled Run: Auto Mode"
                  else
                    if [ "${{ inputs.auto }}" == "true" ]; then ARGS="$ARGS -a"; fi
                    if [ "${{ inputs.force }}" == "true" ]; then ARGS="$ARGS -f"; fi
                    if [ -n "${{ inputs.manual_args }}" ]; then ARGS="$ARGS ${{ inputs.manual_args }}"; fi
                    echo "ðŸ‘¤ Manual Run: Args = $ARGS"
                  fi

                  uv run redeem.py $ARGS

            - name: Commit used codes history
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  commit_message: 'chore(data): update used codes history [skip ci]'
                  file_pattern: 'used/*.txt'
